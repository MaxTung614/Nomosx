# ç®¡ç†å‘˜ç™»å½•é—®é¢˜æ’æŸ¥æŒ‡å—

**æ›´æ–°æ—¶é—´**: 2025-11-05  
**é€‚ç”¨ç‰ˆæœ¬**: NomosX v1.0+

---

## ğŸ¯ å¿«é€Ÿè¯Šæ–­

### ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨æµ‹è¯•å·¥å…·

è®¿é—®æµ‹è¯•å·¥å…·é¡µé¢è¯Šæ–­é—®é¢˜ï¼š

```
http://localhost:5173/admin-test
```

è¿™ä¸ªæµ‹è¯•å·¥å…·ä¼šï¼š
1. âœ… æ˜¾ç¤ºå½“å‰ session çŠ¶æ€
2. âœ… æµ‹è¯•ç™»å½•æµç¨‹
3. âœ… æ˜¾ç¤ºç”¨æˆ·è§’è‰²ä¿¡æ¯
4. âœ… æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ” å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: è¾“å…¥è´¦å·å¯†ç åæ— æ³•ç™»å…¥ï¼Œé¡µé¢ç©ºç™½æˆ–æ˜¾ç¤ºç™»å½•é¡µ

**å¯èƒ½åŸå› **:
- ç”¨æˆ·è´¦å·çš„ role ä¸æ˜¯ 'admin' æˆ– 'cs'
- Session çŠ¶æ€ä¸ AuthProvider çŠ¶æ€ä¸åŒæ­¥
- æµè§ˆå™¨ç¼“å­˜é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:

#### A. æ£€æŸ¥ç”¨æˆ·è§’è‰²

1. è®¿é—® `/admin-test` æµ‹è¯•å·¥å…·
2. è¾“å…¥ä½ çš„ç®¡ç†å‘˜è´¦å·å’Œå¯†ç 
3. ç‚¹å‡»"æµ‹è¯•ç™»å½•"
4. æŸ¥çœ‹ç»“æœä¸­çš„ "Role (from sign-in)" å’Œ "Role (from session)"

å¦‚æœ role æ˜¾ç¤ºä¸º 'user' è€Œä¸æ˜¯ 'admin' æˆ– 'cs'ï¼Œä½ éœ€è¦æ›´æ–°ç”¨æˆ·è§’è‰²ã€‚

#### B. ä½¿ç”¨ Supabase Dashboard æ›´æ–°è§’è‰²

1. ç™»å½•åˆ° [Supabase Dashboard](https://supabase.com/dashboard)
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. è¿›å…¥ **SQL Editor**
4. è¿è¡Œä»¥ä¸‹ SQL è¯­å¥ï¼š

```sql
-- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·åŠå…¶è§’è‰²
SELECT 
  id,
  email,
  raw_user_meta_data->>'role' as role,
  created_at
FROM auth.users
ORDER BY created_at DESC;
```

5. æ‰¾åˆ°ä½ çš„è´¦å·å¯¹åº”çš„ `id`ï¼Œç„¶åè¿è¡Œï¼š

```sql
-- å°†æŒ‡å®šç”¨æˆ·è®¾ç½®ä¸ºç®¡ç†å‘˜
UPDATE auth.users
SET raw_user_meta_data = jsonb_set(
  COALESCE(raw_user_meta_data, '{}'::jsonb),
  '{role}',
  '"admin"'
)
WHERE email = 'your-email@example.com';

-- éªŒè¯æ›´æ–°
SELECT email, raw_user_meta_data->>'role' as role
FROM auth.users
WHERE email = 'your-email@example.com';
```

6. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ cookies**
7. é‡æ–°ç™»å½•

#### C. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

**Chrome / Edge**:
1. æŒ‰ `Ctrl+Shift+Delete` (Windows) æˆ– `Cmd+Shift+Delete` (Mac)
2. é€‰æ‹©"æ‰€æœ‰æ—¶é—´"
3. å‹¾é€‰"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"å’Œ"Cookie åŠå…¶ä»–ç½‘ç«™æ•°æ®"
4. ç‚¹å‡»"æ¸…é™¤æ•°æ®"

**Firefox**:
1. æŒ‰ `Ctrl+Shift+Delete`
2. é€‰æ‹©"å…¨éƒ¨"
3. å‹¾é€‰"ç¼“å­˜"å’Œ"Cookie"
4. ç‚¹å‡»"ç«‹å³æ¸…é™¤"

---

### é—®é¢˜ 2: ç™»å½•åçŸ­æš‚æ˜¾ç¤º Dashboard ç„¶ååˆè·³å›ç™»å½•é¡µ

**å¯èƒ½åŸå› **:
- AuthProvider çŠ¶æ€æ›´æ–°å»¶è¿Ÿ
- Session token è¿‡æœŸ
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:

1. **æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å° (F12)**:
   - æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
   - å…³æ³¨ `[Auth]`ã€`[Router]`ã€`[AdminLogin]` å¼€å¤´çš„æ—¥å¿—

2. **æ£€æŸ¥ Session æ˜¯å¦æœ‰æ•ˆ**:
   - è®¿é—® `/admin-test`
   - ç‚¹å‡»åˆ·æ–°æŒ‰é’®æŸ¥çœ‹å½“å‰ Session çŠ¶æ€
   - å¦‚æœ "Has Session" æ˜¾ç¤º âœ—ï¼Œè¯´æ˜ session å·²è¿‡æœŸ

3. **é‡æ–°ç™»å½•**:
   - ç¡®ä¿å®Œå…¨ç™»å‡ºï¼ˆæ¸…é™¤ sessionï¼‰
   - é‡æ–°è¾“å…¥è´¦å·å¯†ç ç™»å½•

---

### é—®é¢˜ 3: æ˜¾ç¤º "ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å…¥"

**å¯èƒ½åŸå› **:
- Session token ç¡®å®å·²è¿‡æœŸ (é»˜è®¤ 1 å°æ—¶)
- Supabase æœåŠ¡è¿æ¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:

1. ç‚¹å‡»ç™»å‡ºæŒ‰é’®
2. é‡æ–°ç™»å½•
3. å¦‚æœé—®é¢˜æŒç»­ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥
4. æŸ¥çœ‹ Supabase Dashboard ä¸­çš„é¡¹ç›®çŠ¶æ€

---

### é—®é¢˜ 4: é¦–æ¬¡è®¾ç½®ç®¡ç†å‘˜è´¦å·

**å¦‚æœä½ è¿˜æ²¡æœ‰ç®¡ç†å‘˜è´¦å·**ï¼Œå‚è€ƒä»¥ä¸‹æ­¥éª¤ï¼š

#### æ–¹æ³• 1: ä½¿ç”¨ Supabase SQL Editorï¼ˆæ¨èï¼‰

1. ç™»å½• [Supabase Dashboard](https://supabase.com/dashboard)
2. é€‰æ‹©é¡¹ç›®
3. è¿›å…¥ **SQL Editor**
4. åˆ›å»ºæ–°æŸ¥è¯¢ï¼Œç²˜è´´ä»¥ä¸‹ä»£ç ï¼š

```sql
-- åˆ›å»ºç®¡ç†å‘˜è´¦å·çš„å®Œæ•´è„šæœ¬
DO $$
DECLARE
  new_user_id uuid;
BEGIN
  -- åˆ›å»ºæ–°ç”¨æˆ·
  INSERT INTO auth.users (
    instance_id,
    id,
    aud,
    role,
    email,
    encrypted_password,
    email_confirmed_at,
    raw_user_meta_data,
    created_at,
    updated_at,
    confirmation_token,
    recovery_token
  ) VALUES (
    '00000000-0000-0000-0000-000000000000',
    gen_random_uuid(),
    'authenticated',
    'authenticated',
    'admin@example.com',  -- æ”¹æˆä½ çš„é‚®ç®±
    crypt('YourPassword123', gen_salt('bf')),  -- æ”¹æˆä½ çš„å¯†ç 
    NOW(),
    '{"role": "admin", "full_name": "System Admin"}',
    NOW(),
    NOW(),
    '',
    ''
  )
  RETURNING id INTO new_user_id;

  -- æ’å…¥åˆ° identities è¡¨
  INSERT INTO auth.identities (
    id,
    user_id,
    identity_data,
    provider,
    last_sign_in_at,
    created_at,
    updated_at
  ) VALUES (
    gen_random_uuid(),
    new_user_id,
    jsonb_build_object(
      'sub', new_user_id::text,
      'email', 'admin@example.com'  -- æ”¹æˆä½ çš„é‚®ç®±
    ),
    'email',
    NOW(),
    NOW(),
    NOW()
  );

  RAISE NOTICE 'ç®¡ç†å‘˜è´¦å·åˆ›å»ºæˆåŠŸï¼User ID: %', new_user_id;
END $$;
```

5. **ä¿®æ”¹ä»¥ä¸‹å†…å®¹**:
   - `admin@example.com` â†’ ä½ çš„é‚®ç®±
   - `YourPassword123` â†’ ä½ çš„å¯†ç ï¼ˆè‡³å°‘ 6 ä½ï¼‰
   
6. ç‚¹å‡» "Run" æ‰§è¡Œ
7. çœ‹åˆ°æˆåŠŸæ¶ˆæ¯åï¼Œè®¿é—® `/enen` æˆ– `/admin-test` ç™»å½•

#### æ–¹æ³• 2: æ³¨å†Œåæ‰‹åŠ¨å‡çº§

1. åœ¨åº”ç”¨é¦–é¡µæ³¨å†Œä¸€ä¸ªæ™®é€šè´¦å·
2. ä½¿ç”¨ä¸Šé¢"é—®é¢˜ 1 â†’ è§£å†³æ–¹æ¡ˆ B"çš„ SQL è¯­å¥æ›´æ–°è§’è‰²ä¸º admin
3. ç™»å‡ºåé‡æ–°ç™»å½•

---

## ğŸ› ï¸ è°ƒè¯•å·¥å…·è¯´æ˜

### AuthDebugPanel

åœ¨ç®¡ç†å‘˜ç™»å½•é¡µå’Œåå°é¢æ¿å³ä¸‹è§’ä¼šæ˜¾ç¤ºä¸€ä¸ªè°ƒè¯•é¢æ¿ï¼ŒåŒ…å«ï¼š

- **Loading**: AuthProvider æ˜¯å¦æ­£åœ¨åŠ è½½
- **Authenticated**: ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
- **User Email**: å½“å‰ç”¨æˆ·é‚®ç®±
- **Role (Context)**: ä» AuthProvider è·å–çš„è§’è‰²
- **Session Info**: å®æ—¶ session ä¿¡æ¯
- **Role (Session)**: ä» session è·å–çš„è§’è‰²
- **Current Path**: å½“å‰è·¯ç”±è·¯å¾„

**ä½¿ç”¨æ–¹æ³•**:
1. åœ¨ç™»å½•é¡µé¢è§‚å¯Ÿè¿™äº›çŠ¶æ€
2. è¾“å…¥è´¦å·å¯†ç åï¼Œè§‚å¯ŸçŠ¶æ€å˜åŒ–
3. å¦‚æœ "Authenticated" æ˜¾ç¤º âœ“ ä½† "Role" ä¸æ˜¯ admin/csï¼Œè¯´æ˜è§’è‰²è®¾ç½®æœ‰é—®é¢˜
4. ç‚¹å‡»åˆ·æ–°æŒ‰é’®å¯ä»¥é‡æ–°æ£€æŸ¥ session

### AdminLoginTester

è®¿é—® `/admin-test` ä½¿ç”¨å®Œæ•´çš„æµ‹è¯•å·¥å…·ï¼š

**åŠŸèƒ½**:
1. **å½“å‰ Session çŠ¶æ€**: æ˜¾ç¤ºå®æ—¶çš„ session ä¿¡æ¯
2. **æµ‹è¯•ç™»å½•**: è¾“å…¥è´¦å·å¯†ç æµ‹è¯•ç™»å½•æµç¨‹
3. **è¯¦ç»†ç»“æœ**: æ˜¾ç¤ºç™»å½•è¿‡ç¨‹ä¸­çš„æ‰€æœ‰å…³é”®ä¿¡æ¯
4. **é”™è¯¯è¯¦æƒ…**: å¦‚æœå¤±è´¥ï¼Œæ˜¾ç¤ºå®Œæ•´çš„é”™è¯¯å †æ ˆ

**ä½¿ç”¨åœºæ™¯**:
- é¦–æ¬¡è®¾ç½®ç®¡ç†å‘˜æ—¶éªŒè¯è§’è‰²
- æ’æŸ¥ç™»å½•å¤±è´¥åŸå› 
- ç¡®è®¤ session æ˜¯å¦æœ‰æ•ˆ
- å¯¹æ¯”ä¸åŒè´¦å·çš„è§’è‰²å·®å¼‚

---

## ğŸ“Š è®¤è¯æµç¨‹è¯´æ˜

äº†è§£è®¤è¯æµç¨‹æœ‰åŠ©äºè¯Šæ–­é—®é¢˜ï¼š

```
1. ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
   â†“
2. AdminLoginPage è°ƒç”¨ authHelpers.signIn()
   â†“
3. Supabase Auth éªŒè¯è´¦å·å¯†ç 
   â†“
4. è¿”å› user å¯¹è±¡ï¼ˆåŒ…å« user_metadata.roleï¼‰
   â†“
5. AdminLoginPage è°ƒç”¨ onLoginSuccess(role)
   â†“
6. Router æ”¶åˆ°å›è°ƒï¼Œç­‰å¾… 300ms
   â†“
7. Router å¯¼èˆªåˆ° /enen
   â†“
8. AuthProvider çš„ onAuthStateChange è§¦å‘ SIGNED_IN äº‹ä»¶
   â†“
9. AuthProvider æ›´æ–° isAuthenticated å’Œ userRole çŠ¶æ€
   â†“
10. Router é‡æ–°æ¸²æŸ“ï¼Œæ£€æŸ¥ isAuthenticated å’Œ userRole
   â†“
11. å¦‚æœ role æ˜¯ admin/csï¼Œæ˜¾ç¤º AdminDashboard
    å¦åˆ™æ˜¾ç¤º AdminLoginPage
```

**æ½œåœ¨é—®é¢˜ç‚¹**:
- **æ­¥éª¤ 4**: å¦‚æœ user_metadata.role ä¸æ˜¯ admin/csï¼Œåç»­æµç¨‹ä¼šå¤±è´¥
- **æ­¥éª¤ 8-9**: å¦‚æœ AuthProvider çŠ¶æ€æ›´æ–°æ…¢ï¼Œå¯èƒ½å¯¼è‡´æ­¥éª¤ 10 åˆ¤æ–­å¤±è´¥
- **æ­¥éª¤ 10**: å¦‚æœ isAuthenticated æ˜¯ true ä½† userRole è¿˜æ˜¯æ—§å€¼ï¼Œä¼šé‡æ–°æ˜¾ç¤ºç™»å½•é¡µ

---

## ğŸ” å®‰å…¨æç¤º

1. **ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨é»˜è®¤å¯†ç **
2. **å®šæœŸæ›´æ¢ç®¡ç†å‘˜å¯†ç **
3. **ä¸è¦å…±äº«ç®¡ç†å‘˜è´¦å·**
4. **ä½¿ç”¨å¼ºå¯†ç ** (è‡³å°‘ 12 ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦)
5. **åˆ é™¤æµ‹è¯•è´¦å·** (`/admin-test` ä»…ç”¨äºå¼€å‘ç¯å¢ƒ)

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¿«é€Ÿè®¾ç½®ç®¡ç†å‘˜](/docs/admin/quick-setup-admin.md)
- [ç®¡ç†å‘˜è®¿é—®æŒ‡å—](/docs/admin/admin-access-guide.md)
- [ç®¡ç†å‘˜è§’è‰²ä¿®å¤æŒ‡å—](/docs/admin/admin-role-fix-guide.md)
- [è®¤è¯ä¿®å¤æµ‹è¯•æŒ‡å—](/docs/testing/auth-fix-testing-guide.md)

---

## ğŸ’¡ ä»ç„¶æ— æ³•è§£å†³ï¼Ÿ

å¦‚æœæŒ‰ç…§ä¸Šè¿°æ­¥éª¤ä»ç„¶æ— æ³•ç™»å½•ï¼Œè¯·ï¼š

1. **æ”¶é›†è¯Šæ–­ä¿¡æ¯**:
   - è®¿é—® `/admin-test`
   - æµ‹è¯•ç™»å½•å¹¶æˆªå›¾ç»“æœ
   - æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
   - æˆªå›¾ Console ä¸­çš„é”™è¯¯æ—¥å¿—

2. **æ£€æŸ¥ä»¥ä¸‹å†…å®¹**:
   - Supabase é¡¹ç›®æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
   - æµè§ˆå™¨æ˜¯å¦æ”¯æŒ (æ¨è Chrome/Edge/Firefox æœ€æ–°ç‰ˆæœ¬)
   - æ˜¯å¦å¯ç”¨äº†æµè§ˆå™¨éšç§æ¨¡å¼ï¼ˆå¯èƒ½é˜»æ­¢ cookiesï¼‰

3. **ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**:
   - å°è¯•ä½¿ç”¨æ— ç—•/éšç§æ¨¡å¼
   - å°è¯•ä¸åŒçš„æµè§ˆå™¨
   - æ¸…é™¤æ‰€æœ‰ç«™ç‚¹æ•°æ®åé‡è¯•

---

**æç¤º**: å¼€å‘ç¯å¢ƒä¸‹å¯ä»¥ä¿ç•™ `/admin-test` å’Œ `AuthDebugPanel`ï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰åº”è¯¥ç§»é™¤è¿™äº›è°ƒè¯•å·¥å…·ã€‚
